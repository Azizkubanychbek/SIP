<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä - –ß–∞—Ç</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            height: 100vh;
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            background: #667eea;
            color: white;
        }

        .sidebar-header h2 {
            margin-bottom: 10px;
        }

        .current-user {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .users-list {
            flex: 1;
            overflow-y: auto;
        }

        .user-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-item:hover {
            background: #f8f9fa;
        }

        .user-item.active {
            background: #e3f2fd;
            border-left: 4px solid #667eea;
        }

        .user-item .username {
            font-weight: bold;
            color: #333;
        }

        .user-item .email {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header h3 {
            color: #333;
        }

        .call-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-call {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-call.audio {
            background: #28a745;
            color: white;
        }

        .btn-call.video {
            background: #dc3545;
            color: white;
        }

        .btn-call:hover {
            opacity: 0.8;
        }

        /* –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.sent {
            align-items: flex-end;
        }

        .message.received {
            align-items: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.sent .message-content {
            background: #667eea;
            color: white;
        }

        .message.received .message-content {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .message.sent .message-time {
            text-align: right;
        }

        /* –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ */
        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #ddd;
        }

        .message-input-container {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            resize: none;
        }

        .message-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-send {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-send:hover {
            background: #5a6fd8;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.info {
            background: #17a2b8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* –ó–≤–æ–Ω–∫–∏ */
        .call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .call-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
        }

        .call-buttons-modal {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-call-modal {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .btn-answer {
            background: #28a745;
            color: white;
        }

        .btn-decline {
            background: #dc3545;
            color: white;
        }

        .btn-end {
            background: #6c757d;
            color: white;
        }

        /* WebRTC –≤–∏–¥–µ–æ */
        .video-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .video-stream {
            width: 200px;
            height: 150px;
            background: #000;
            border-radius: 8px;
        }

        video {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>üí¨ –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h2>
                <div class="current-user" id="currentUser">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
            <div class="users-list" id="usersList">
                <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="chat-main">
            <div class="chat-header">
                <h3 id="chatTitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞—á–∞–ª–∞ —á–∞—Ç–∞</h3>
                <div class="call-buttons" id="callButtons" style="display: none;">
                    <button class="btn-call audio" onclick="startCall('audio')">
                        üìû –ê—É–¥–∏–æ
                    </button>
                    <button class="btn-call video" onclick="startCall('video')">
                        üìπ –í–∏–¥–µ–æ
                    </button>
                </div>
            </div>

            <div class="messages-area" id="messagesArea">
                <div style="text-align: center; color: #666; margin-top: 50px;">
                    –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è
                </div>
            </div>

            <div class="input-area">
                <div class="message-input-container">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                        rows="1"
                        disabled
                    ></textarea>
                    <button class="btn-send" id="sendButton" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–≤–æ–Ω–∫–∞ -->
    <div class="call-modal" id="callModal">
        <div class="call-content">
            <h3 id="callTitle">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</h3>
            <p id="callInfo">–ó–≤–æ–Ω–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>
            
            <div class="call-buttons-modal" id="callButtonsModal">
                <button class="btn-call-modal btn-answer" onclick="answerCall(true)">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                <button class="btn-call-modal btn-decline" onclick="answerCall(false)">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>

            <div class="call-buttons-modal" id="endCallButton" style="display: none;">
                <button class="btn-call-modal btn-end" onclick="endCall()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>

            <div class="video-container" id="videoContainer" style="display: none;">
                <div class="video-stream">
                    <video id="localVideo" autoplay muted></video>
                </div>
                <div class="video-stream">
                    <video id="remoteVideo" autoplay></video>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        let selectedUser = null;
        let socket = null;
        let peerConnection = null;
        let localStream = null;
        let currentCallId = null;
        let isInCall = false;
        let isCallInitiator = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initializeSocket();
            loadUsers();
            setupEventListeners();
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            fetch('/api/me', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Unauthorized');
                }
                return response.json();
            })
            .then(user => {
                currentUser = user;
                document.getElementById('currentUser').textContent = `${user.username} (${user.email})`;
            })
            .catch(error => {
                localStorage.removeItem('token');
                window.location.href = '/';
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É');
                const token = localStorage.getItem('token');
                if (token) {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    socket.emit('join', payload.id);
                }
            });

            socket.on('user_joined', (data) => {
                console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è:', data);
                loadUsers();
            });

            socket.on('user_left', (data) => {
                console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è:', data);
                loadUsers();
            });

            socket.on('new_message', (message) => {
                console.log('üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
                addMessageToChat(message);
            });

            socket.on('incoming_call', (data) => {
                console.log('üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫:', data);
                showIncomingCall(data);
            });

            socket.on('call_answered', (data) => {
                console.log('üìû –ó–≤–æ–Ω–æ–∫ –æ—Ç–≤–µ—á–µ–Ω:', data);
                if (data.answer && isCallInitiator) {
                    // –ï—Å–ª–∏ –º—ã –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä –∏ –∑–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç, –∑–∞–ø—É—Å–∫–∞–µ–º WebRTC
                    document.getElementById('callTitle').textContent = '–ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω';
                    document.getElementById('callInfo').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...';
                    document.getElementById('callButtonsModal').style.display = 'none';
                    document.getElementById('endCallButton').style.display = 'flex';
                    document.getElementById('callModal').style.display = 'flex';
                    
                    startWebRTC();
                } else if (!data.answer) {
                    // –ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω
                    endCall();
                    showNotification('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'info');
                }
            });

            socket.on('call_ended', (data) => {
                console.log('üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω:', data);
                endCall();
            });

            socket.on('webrtc_signal', (data) => {
                console.log('üì° WebRTC —Å–∏–≥–Ω–∞–ª:', data);
                handleWebRTCSignal(data);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function loadUsers() {
            const token = localStorage.getItem('token');
            
            fetch('/api/users', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(users => {
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '';
                
                users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.onclick = () => selectUser(user);
                    
                    userItem.innerHTML = `
                        <div class="username">${user.username}</div>
                        <div class="email">${user.email}</div>
                    `;
                    
                    usersList.appendChild(userItem);
                });
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            });
        }

        // –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function selectUser(user) {
            selectedUser = user;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.user-item').classList.add('active');
            
            document.getElementById('chatTitle').textContent = `–ß–∞—Ç —Å ${user.username}`;
            document.getElementById('callButtons').style.display = 'flex';
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            loadMessages(user.id);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function loadMessages(userId) {
            const token = localStorage.getItem('token');
            
            fetch(`/api/messages/${userId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(messages => {
                const messagesArea = document.getElementById('messagesArea');
                messagesArea.innerHTML = '';
                
                messages.forEach(message => {
                    addMessageToChat(message);
                });
                
                messagesArea.scrollTop = messagesArea.scrollHeight;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessageToChat(message) {
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');
            
            const isSent = message.sender_id == currentUser.id;
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            
            const time = new Date(message.created_at).toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <div class="message-content">${message.content}</div>
                <div class="message-time">${time}</div>
            `;
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –∫–Ω–æ–ø–∫–µ
            sendButton.addEventListener('click', sendMessage);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            if (!selectedUser) return;
            
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            const token = localStorage.getItem('token');
            
            fetch('/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    receiverId: selectedUser.id,
                    content: content
                })
            })
            .then(response => response.json())
            .then(message => {
                messageInput.value = '';
                messageInput.style.height = 'auto';
                addMessageToChat(message);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Socket.IO –¥–ª—è real-time
                socket.emit('send_message', {
                    receiverId: selectedUser.id,
                    content: content
                });
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
            });
        }

        // –ù–∞—á–∞–ª–æ –∑–≤–æ–Ω–∫–∞
        function startCall(type) {
            if (!selectedUser || isInCall) return;
            
            console.log(`üìû –ù–∞—á–∞–ª–æ ${type} –∑–≤–æ–Ω–∫–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${selectedUser.username}`);
            
            currentCallId = 'call-' + Date.now();
            isCallInitiator = true; // –ú—ã –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä –∑–≤–æ–Ω–∫–∞
            
            socket.emit('call_user', {
                targetUserId: selectedUser.id,
                callType: type,
                callId: currentCallId
            });
            
            showNotification(`–ò–Ω–∏—Ü–∏–∞—Ü–∏—è ${type === 'audio' ? '–∞—É–¥–∏–æ' : '–≤–∏–¥–µ–æ'} –∑–≤–æ–Ω–∫–∞`, 'info');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
        function showIncomingCall(data) {
            console.log('üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫:', data);
            
            currentCallId = data.callId;
            isCallInitiator = false; // –ú—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä
            
            document.getElementById('callTitle').textContent = '–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫';
            document.getElementById('callInfo').textContent = `–ó–≤–æ–Ω–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID: ${data.callerId}`;
            document.getElementById('callButtonsModal').style.display = 'flex';
            document.getElementById('endCallButton').style.display = 'none';
            document.getElementById('videoContainer').style.display = 'none';
            
            document.getElementById('callModal').style.display = 'flex';
        }

        // –û—Ç–≤–µ—Ç –Ω–∞ –∑–≤–æ–Ω–æ–∫
        function answerCall(answer) {
            console.log('üìû –û—Ç–≤–µ—Ç –Ω–∞ –∑–≤–æ–Ω–æ–∫:', answer);
            
            socket.emit('answer_call', {
                callId: currentCallId,
                answer: answer
            });
            
            if (answer) {
                document.getElementById('callTitle').textContent = '–ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω';
                document.getElementById('callInfo').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...';
                document.getElementById('callButtonsModal').style.display = 'none';
                document.getElementById('endCallButton').style.display = 'flex';
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º WebRTC
                startWebRTC();
            } else {
                endCall();
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
        function endCall() {
            if (currentCallId) {
                socket.emit('end_call', { callId: currentCallId });
            }
            
            document.getElementById('callModal').style.display = 'none';
            currentCallId = null;
            isInCall = false;
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
        }

        // WebRTC
        async function startWebRTC() {
            try {
                let stream = null;
                try {
                    // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏ –≤–∏–¥–µ–æ, –∏ –∞—É–¥–∏–æ
                    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                } catch (err) {
                    // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º —Ç–æ–ª—å–∫–æ –∞—É–¥–∏–æ
                    alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–±—É–µ–º —Ç–æ–ª—å–∫–æ –∞—É–¥–∏–æ.\n' + err.message);
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                    } catch (err2) {
                        alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.\n' + err2.message);
                        throw err2;
                    }
                }
                localStream = stream;
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('localVideo').muted = true;
                
                peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' }
                    ]
                });
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                peerConnection.ontrack = (event) => {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                    document.getElementById('remoteVideo').muted = false;
                };
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('webrtc_signal', {
                            targetUserId: selectedUser.id,
                            signal: event.candidate,
                            type: 'candidate'
                        });
                    }
                };
                if (isCallInitiator) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    socket.emit('webrtc_signal', {
                        targetUserId: selectedUser.id,
                        signal: offer,
                        type: 'offer'
                    });
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ WebRTC: ' + error.message);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ WebRTC —Å–∏–≥–Ω–∞–ª–æ–≤
        async function handleWebRTCSignal(data) {
            if (!peerConnection) {
                console.log('‚ùå RTCPeerConnection –Ω–µ —Å–æ–∑–¥–∞–Ω');
                return;
            }
            
            console.log('üì° –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–∞:', data.type);
            
            try {
                if (data.type === 'offer') {
                    console.log('üì• –ü–æ–ª—É—á–µ–Ω offer');
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.signal));
                    
                    console.log('üì§ –°–æ–∑–¥–∞–Ω–∏–µ answer...');
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    socket.emit('webrtc_signal', {
                        targetUserId: data.fromUserId,
                        signal: answer,
                        type: 'answer'
                    });
                    
                } else if (data.type === 'answer') {
                    console.log('üì• –ü–æ–ª—É—á–µ–Ω answer');
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.signal));
                    
                } else if (data.type === 'candidate') {
                    console.log('üì• –ü–æ–ª—É—á–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç');
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.signal));
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–∞:', error);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
    </script>
</body>
</html> 